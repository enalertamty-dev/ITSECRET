<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Mensajes Secretos</title>
    <!-- Se añade la biblioteca crypto-js para el cifrado -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Space Mono', monospace; }
        textarea:focus, input:focus { box-shadow: 0 0 0 2px #4ade80; } /* Resplandor verde al enfocar */
        .drop-zone {
            border: 2px dashed #4a5568;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .drop-zone.dragover {
            background-color: #2d3748;
            border-color: #4ade80;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl max-w-2xl w-full text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 21h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            <h1 class="text-3xl md:text-4xl font-bold mb-2">Generador de Mensajes</h1>
            <p class="text-gray-400 mb-6">Crea un mensaje cifrado de un solo uso.</p>
            
            <div class="mb-4">
                <label for="secret-message-input" class="block text-left text-gray-400 mb-2">Mensaje:</label>
                <textarea id="secret-message-input" class="w-full h-32 p-3 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-green-300 resize-none" placeholder="Escribe tu mensaje aquí..."></textarea>
            </div>

            <div class="mb-4">
                <label for="file-upload" class="block text-left text-gray-400 mb-2">Adjuntar Archivo (Las imágenes se optimizarán):</label>
                <div id="drop-zone" class="drop-zone p-6 rounded-lg text-center cursor-pointer">
                    <input type="file" id="file-upload" class="hidden" accept="image/*,video/*">
                    <p id="drop-zone-text">Arrastra y suelta un archivo, o haz clic aquí.</p>
                    <div id="file-preview" class="hidden mt-4 text-sm text-green-400"></div>
                </div>
            </div>

            <div class="mb-4">
                <label for="media-url-input" class="block text-left text-gray-400 mb-2">O pega una URL de Imagen / Video de YouTube:</label>
                <input type="url" id="media-url-input" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-green-300" placeholder="https://ejemplo.com/imagen.jpg o https://youtube.com/watch?v=...">
                <p class="text-xs text-gray-500 text-left mt-1">Nota: Para videos, ajusta la duración del mensaje manualmente.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="secret-key-input" class="block text-left text-gray-400 mb-2">Clave Secreta:</label>
                    <input type="password" id="secret-key-input" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-green-300" placeholder="Clave para cifrar...">
                </div>
                <div>
                    <label for="duration-input" class="block text-left text-gray-400 mb-2">Duración (segundos):</label>
                    <input type="number" id="duration-input" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-green-300" value="5" min="1">
                </div>
            </div>
            
            <button id="generate-button" class="mt-8 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                Generar Archivo de Mensaje
            </button>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileUpload = document.getElementById('file-upload');
        const filePreview = document.getElementById('file-preview');
        const dropZoneText = document.getElementById('drop-zone-text');
        const urlInput = document.getElementById('media-url-input');
        let fileDataBase64 = null;
        let fileType = null;

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });
        dropZone.addEventListener('click', () => fileUpload.click());
        fileUpload.addEventListener('change', () => { if (fileUpload.files.length > 0) handleFile(fileUpload.files[0]); });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                const videoMaxSize = 5 * 1024 * 1024;
                if (file.size > videoMaxSize) {
                    alert("Los videos no se pueden optimizar y superan el límite de 5 MB. Por favor, usa un video más pequeño o un enlace de YouTube.");
                    removeFile();
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    fileDataBase64 = e.target.result;
                    fileType = file.type;
                    updatePreview(file.name, file.size);
                };
                reader.readAsDataURL(file);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 1280;
                    const MAX_HEIGHT = 720;
                    let { width, height } = img;
                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } }
                    else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    fileDataBase64 = compressedDataUrl;
                    fileType = 'image/jpeg';
                    updatePreview(file.name, file.size, compressedDataUrl.length);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updatePreview(fileName, originalSizeBytes, newSizeBytes) {
            let previewText = `Archivo cargado: <strong>${fileName}</strong>`;
            if (newSizeBytes) {
                const originalSizeKB = (originalSizeBytes / 1024).toFixed(1);
                const newSizeKB = ((newSizeBytes * 3 / 4) / 1024).toFixed(1);
                previewText += ` (optimizado de ${originalSizeKB}KB a ${newSizeKB}KB)`;
            }
            previewText += ` <button onclick="removeFile(event)" class="text-red-500 ml-2 font-bold">[X]</button>`;
            filePreview.innerHTML = previewText;
            filePreview.classList.remove('hidden');
            dropZoneText.classList.add('hidden');
            urlInput.disabled = true;
            urlInput.value = '';
        }

        function removeFile(event) {
            if(event) event.stopPropagation();
            fileDataBase64 = null;
            fileType = null;
            fileUpload.value = '';
            filePreview.classList.add('hidden');
            dropZoneText.classList.remove('hidden');
            urlInput.disabled = false;
        }

        document.getElementById('generate-button').addEventListener('click', () => {
            const userMessage = document.getElementById('secret-message-input').value;
            const secretKey = document.getElementById('secret-key-input').value;
            const duration = parseInt(document.getElementById('duration-input').value, 10) || 5;

            if (!userMessage.trim()) { alert("Por favor, introduce un mensaje."); return; }
            if (!secretKey.trim()) { alert("Por favor, introduce una clave secreta para cifrar el mensaje."); return; }

            let mediaPayload = { data: '', type: '' };
            if (fileDataBase64) {
                mediaPayload = { data: fileDataBase64, type: fileType };
            } else if (urlInput.value.trim()) {
                mediaPayload = { data: urlInput.value.trim(), type: 'url' };
            }

            const uniqueId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
            const payload = { id: uniqueId, message: userMessage, media: mediaPayload, duration: duration };
            const stringifiedPayload = JSON.stringify(payload);
            const encryptedPayload = CryptoJS.AES.encrypt(stringifiedPayload, secretKey).toString();
            const encodedPayload = btoa(encryptedPayload);
            
            const clientHtmlContent = createClientHtml(encodedPayload);
            const blob = new Blob([clientHtmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mensaje-secreto.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function createClientHtml(encodedPayload) {
            return `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Mensaje Secreto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"><\/script>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Space Mono', monospace; } </style>
</head>
<body class="bg-gray-900 text-white transition-all duration-500">
    <div id="main-container" class="min-h-screen flex items-center justify-center p-4">
        <div id="content-wrapper" class="text-center"></div>
    </div>
<script>
    window.onload = () => {
        const contentWrapper = document.getElementById('content-wrapper');
        const encodedData = '${encodedPayload}';
        showPasswordPrompt();
        document.getElementById('decrypt-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const secretKeyInput = document.getElementById('secret-key-input');
            const secretKey = secretKeyInput.value;
            try {
                const decodedData = atob(encodedData);
                const bytes = CryptoJS.AES.decrypt(decodedData, secretKey);
                const decryptedJson = bytes.toString(CryptoJS.enc.Utf8);
                if (!decryptedJson) { throw new Error("Invalid key"); }
                const data = JSON.parse(decryptedJson);
                const viewedKey = 'secretMessageViewed_' + data.id;
                if (localStorage.getItem(viewedKey) === 'true') { showDestroyedScreen(); return; }
                localStorage.setItem(viewedKey, 'true');
                showInitialMessage(data.message, data.media);
                const duration = data.duration || 5;
                let secondsLeft = duration;
                const countdownTimer = document.getElementById('countdown-timer');
                countdownTimer.textContent = \`Este mensaje se autodestruirá en \${secondsLeft} segundos...\`;
                const countdownInterval = setInterval(() => {
                    secondsLeft--;
                    countdownTimer.textContent = secondsLeft > 0 ? \`Este mensaje se autodestruirá en \${secondsLeft} segundos...\` : 'Iniciando secuencia de borrado...';
                    if (secondsLeft <= 0) clearInterval(countdownInterval);
                }, 1000);
                setTimeout(showDestroyedScreen, duration * 1000);
            } catch (err) {
                secretKeyInput.value = '';
                secretKeyInput.placeholder = 'Clave incorrecta. Intento fallido.';
                secretKeyInput.classList.add('border-red-500', 'animate-pulse');
                setTimeout(showDestroyedScreen, 1500);
            }
        });
    };
    function showPasswordPrompt() {
        document.getElementById('content-wrapper').innerHTML = \`
            <div class="bg-gray-800 p-8 rounded-lg shadow-2xl max-w-md w-full">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                <h1 class="text-2xl font-bold mb-2">Mensaje Cifrado</h1>
                <p class="text-gray-400 mb-6">Se requiere la clave secreta para descifrar.</p>
                <form id="decrypt-form">
                    <input type="password" id="secret-key-input" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-green-300" placeholder="Introduce la clave secreta...">
                    <button type="submit" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">Descifrar</button>
                </form>
            </div>\`;
    }
    function showInitialMessage(message, media) {
        let mediaHtml = '';
        if (media && media.data) {
            let mediaUrl = media.data, mediaType = media.type;
            if (mediaType === 'url' && mediaUrl.includes('youtube.com/watch?v=')) mediaUrl = mediaUrl.replace("watch?v=", "embed/");
            else if (mediaType === 'url' && mediaUrl.includes('youtu.be/')) mediaUrl = mediaUrl.replace("youtu.be/", "www.youtube.com/embed/");
            if (mediaType.includes('youtube')) mediaHtml = \`<div class="aspect-w-16 aspect-h-9 mb-6"><iframe src="\${mediaUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full rounded-lg shadow-lg"></iframe></div>\`;
            else if (mediaType.startsWith('video/')) mediaHtml = \`<video src="\${mediaUrl}" controls autoplay muted class="max-w-xs h-auto mx-auto rounded-lg mb-6 shadow-lg"></video>\`;
            else mediaHtml = \`<img src="\${mediaUrl}" alt="Contenido multimedia" class="max-w-xs h-auto mx-auto rounded-lg mb-6 shadow-lg" onerror="this.style.display='none'">\`;
        }
        document.getElementById('content-wrapper').innerHTML = \`
            <div class="bg-gray-800 p-8 rounded-lg shadow-2xl max-w-2xl w-full">
                \${mediaHtml}
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-yellow-400 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <h1 class="text-2xl md:text-4xl font-bold text-green-400 break-words mb-4">"\${message}"</h1>
                <p id="countdown-timer" class="text-lg md:text-xl text-yellow-400"></p>
            </div>\`;
    }
    function showDestroyedScreen() {
        document.body.className = 'bg-black text-white';
        document.getElementById('content-wrapper').innerHTML = \`
            <div class="flex flex-col items-center justify-center p-4 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 mb-6 text-red-600 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m-12.728 0a9 9 0 010-12.728m12.728 0L5.636 18.364m12.728 0L5.636 5.636" /></svg>
                <h1 class="text-3xl md:text-5xl font-bold text-red-600">TRANSMISIÓN TERMINADA</h1>
                <p class="text-xl md:text-2xl mt-4 text-red-700">[ ACCESO DENEGADO O MENSAJE BORRADO ]</p>
            </div>\`;
    }
<\/script>
</body>
</html>`;
        }
    </script>
</body>
</html>

